<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>ì¦ê²¨ì°¾ê¸° Â· Cafe MSA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- âœ… ê³µí†µ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" th:href="@{/css/style.css}"/>

    <!-- âœ… ì¦ê²¨ì°¾ê¸° ì „ìš© ìŠ¤íƒ€ì¼ ì•½ê°„ ì¶”ê°€ -->
    <style>
        .main-content .container {
            max-width: 960px;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--coffee, #5c3b2e);
        }

        .page-subtitle {
            font-size: 0.85rem;
            color: #8f7a63;
        }

        .card-elevated {
            border-radius: 1rem;
            border: 0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
            background: #ffffff;
        }

        .favorite-heart {
            color: #e24f6b;
        }

        .fav-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.78rem;
            padding: 0.15rem 0.45rem;
            border-radius: 999px;
            background: #ffe9f0;
            color: #c53f5a;
        }

        .fav-product-name {
            font-weight: 600;
            color: #4b3425;
        }

        .fav-product-meta {
            font-size: 0.78rem;
            color: #a08f7e;
        }

        .fav-btn-icon {
            padding-inline: 0.6rem;
        }
    </style>
</head>
<body class="body-cream">

<!-- âœ… ê³µí†µ ë„¤ë¹„ê²Œì´ì…˜ -->
<div th:replace="~{fragments/nav :: mainNav}"></div>

<main class="main-content">
    <div class="container mt-4">

        <!-- âœ… ì œëª© ì˜ì—­ (ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼í•œ êµ¬ì¡°) -->
        <div class="d-flex justify-content-between align-items-center mb-0 p-3">
            <div>
                <h2 class="page-title mb-1">
                    <i class="bi bi-heart-fill favorite-heart me-2"></i>
                    ë‚´ ì¦ê²¨ì°¾ê¸°
                </h2>
                <div class="page-subtitle">
                    ìì£¼ ì£¼ë¬¸í•˜ëŠ” ë©”ë‰´ë¥¼ ëª¨ì•„ë‘ê³  í•œ ë²ˆì— ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•„ë³´ì„¸ìš”.
                </div>
            </div>
            <a href="/products" class="btn btn-outline-coffee">
                <i class="bi bi-plus-lg me-1"></i>ìƒí’ˆ ë³´ëŸ¬ê°€ê¸°
            </a>
        </div>

        <!-- âœ… ë¹„ì–´ ìˆì„ ë•Œ ì¹´ë“œ -->
        <div id="fav-empty" class="box-empty d-none">
            <div class="card card-elevated text-center py-5">
                <div class="card-body d-flex flex-column align-items-center">
                    <div class="mb-3">
                        <i class="bi bi-heart favorite-heart fs-1"></i>
                    </div>
                    <h4 class="mb-2">ì¦ê²¨ì°¾ê¸°í•œ ë©”ë‰´ê°€ ì•„ì§ ì—†ì–´ìš”</h4>
                    <p class="text-muted mb-4">
                        ìì£¼ ë§ˆì‹œëŠ” ì»¤í”¼ì™€ ë””ì €íŠ¸ë¥¼ ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€í•´ ë‘ê³  ë¹ ë¥´ê²Œ ì£¼ë¬¸í•´ë³´ì„¸ìš” â˜•ğŸ’–
                    </p>
                    <a href="/products" class="btn btn-coffee">
                        <i class="bi bi-cup-hot me-1"></i>
                        ìƒí’ˆ ë³´ëŸ¬ê°€ê¸°
                    </a>
                </div>
            </div>
        </div>

        <!-- ì—ëŸ¬ ì˜ì—­ -->
        <div id="fav-error" class="alert alert-danger d-none mt-3"></div>

        <!-- âœ… ì¦ê²¨ì°¾ê¸° ëª©ë¡ ì¹´ë“œ -->
        <div class="card card-elevated mt-3 d-none" id="fav-card">
            <div class="p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="fav-tag">
                        <i class="bi bi-heart-fill"></i> ì¦ê²¨ì°¾ê¸° ëª©ë¡
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-cafe table-hover mb-0 align-middle">
                        <thead>
                        <tr>
                            <th style="width:60px;">#</th>
                            <th>ìƒí’ˆ</th>
                            <th style="width:120px;">ì¹´í…Œê³ ë¦¬</th>
                            <th class="text-end" style="width:140px;">ê°€ê²©</th>
                            <th class="text-end" style="width:110px;">ë‹´ê¸°</th>
                            <th class="text-end" style="width:110px;">ì‚­ì œ</th>
                        </tr>
                        </thead>
                        <tbody id="fav-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</main>

<!-- âœ… ê³µí†µ í‘¸í„° -->
<div th:replace="~{fragments/footer :: mainFooter}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- ê³µí†µ ë„¤ë¹„/ë¡œê·¸ì¸ ìƒíƒœ ê´€ë¦¬ -->
<script th:src="@{/js/nav-common.js}"></script>

<script>
    // ===== ìœ ì €/ê³µí†µ =====
    let CURRENT_USER_ID = null;

    function resolveUserId() {
        const fromNew   = localStorage.getItem('userId');
        const fromLocal = localStorage.getItem('USER_ID');
        const fromSess  = sessionStorage.getItem('USER_ID');
        return fromNew || fromLocal || fromSess || '1';
    }

    // ===== ì¦ê²¨ì°¾ê¸° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° =====
    async function loadFavorites() {
        const bodyEl  = document.getElementById('fav-body');
        const cardEl  = document.getElementById('fav-card');
        const emptyEl = document.getElementById('fav-empty');
        const errorEl = document.getElementById('fav-error');

        bodyEl.innerHTML = '';
        errorEl.classList.add('d-none');
        errorEl.textContent = '';

        try {
            const res = await fetch('/api/bookmarks', {
                method: 'GET',
                headers: {
                    'X-User-Id': String(CURRENT_USER_ID)  // âœ… ë¶ë§ˆí¬ ì„œë¹„ìŠ¤ìš© í—¤ë”
                }
            });

            if (!res.ok) throw new Error('ì¦ê²¨ì°¾ê¸° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            const data = await res.json();

            if (!data || data.length === 0) {
                cardEl.classList.add('d-none');
                emptyEl.classList.remove('d-none');
                return;
            }

            emptyEl.classList.add('d-none');
            cardEl.classList.remove('d-none');

            data.forEach((bm, i) => {
                const tr = document.createElement('tr');
                const priceText =
                    bm.price != null ? Number(bm.price).toLocaleString() + 'ì›' : '-';

                tr.innerHTML = `
                    <td class="text-muted">${i + 1}</td>
                    <td>
                        <div class="fav-product-name">${bm.productName ?? '(ì´ë¦„ ì—†ìŒ)'}</div>
                        <div class="fav-product-meta">ìƒí’ˆ ID: #${bm.productId}</div>
                    </td>
                    <td>${bm.category ?? '-'}</td>
                    <td class="text-end fw-semibold">${priceText}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-coffee fav-btn-icon"
                                title="ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°"
                                onclick="addFromFavoriteToCart(${bm.productId})">
                            <i class="bi bi-bag-plus"></i>
                        </button>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-soft fav-btn-icon"
                                title="ì¦ê²¨ì°¾ê¸° ì‚­ì œ"
                                onclick="deleteFavorite(${bm.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                bodyEl.appendChild(tr);
            });
        } catch (err) {
            errorEl.textContent = err.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            errorEl.classList.remove('d-none');
            cardEl.classList.add('d-none');
            emptyEl.classList.add('d-none');
        }
    }

    // ===== ì¦ê²¨ì°¾ê¸°ì—ì„œ ì¥ë°”êµ¬ë‹ˆë¡œ ë‹´ê¸° =====
    async function addFromFavoriteToCart(productId) {
        try {
            const res = await fetch('/api/cart/items', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-USER-ID': String(CURRENT_USER_ID)   // âœ… ì¥ë°”êµ¬ë‹ˆ ì„œë¹„ìŠ¤ìš© í—¤ë” (ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼)
                },
                body: JSON.stringify({
                    productId: productId,
                    quantity: 1
                })
            });

            if (!res.ok) {
                const text = await res.text().catch(() => '');
                throw new Error(`ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ${text}`);
            }

            window.location.href = '/cart';
        } catch (err) {
            alert(err.message || 'ì¥ë°”êµ¬ë‹ˆë¡œ ë³´ë‚´ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ===== ì¦ê²¨ì°¾ê¸° ì‚­ì œ =====
    async function deleteFavorite(id) {
        if (!confirm('ì´ ì¦ê²¨ì°¾ê¸°ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;

        try {
            const res = await fetch(`/api/bookmarks/${id}`, {
                method: 'DELETE',
                headers: {
                    'X-User-Id': String(CURRENT_USER_ID)   // âœ… ë¶ë§ˆí¬ ì„œë¹„ìŠ¤ìš© í—¤ë”
                }
            });
            if (!res.ok) throw new Error('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            await loadFavorites();
        } catch (err) {
            alert(err.message || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ===== ì´ˆê¸° ì§„ì… =====
    document.addEventListener('DOMContentLoaded', () => {
        const token    = localStorage.getItem('token');
        const username = localStorage.getItem('username');

        if (!token || !username) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            location.href = '/login';
            return;
        }

        CURRENT_USER_ID = resolveUserId();
        loadFavorites().catch(console.error);
    });
</script>
</body>
</html>
